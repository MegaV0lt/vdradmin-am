<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>

<head>
	<meta http-equiv="refresh" content="600; URL=vdradmin.pl?aktion=prog_timeline" />
	<meta http-equiv="content-type" content="text/html;<%! charset=ISO-8859-1 !%>" />
	<title>VDRAdmin - <%! What's On Now? !%></title>
	<link href="style.css" rel="stylesheet" media="screen" type="text/css" />
	<tmpl_if usercss>
		<link href="user.css" rel="stylesheet" media="screen" type="text/css" />
	</tmpl_if>
	<script type="text/javascript" language="JavaScript1.2" src="library.js"></script>

<?%- 
	breite = 600;
	seite = 100;
	left = 20;
	zeitrahmen 	= config.ZEITRAHMEN || 1; # Zeitrahmen der angezeigt werden soll in Stunden
	times 		= config.TIMES.split(',\s*');
	
	USE date;
	jetzt_stunde = date.format(date.now, '%H');
	jetzt_minute = date.format(date.now, '%M');
	akt_stunde = date.format(now_sec, '%H');
	akt_minute = (date.format(now_sec, '%M') < 30 ? '00' : '30');
	diff_minute = jetzt_minute - akt_minute; 

	IF date.format(date.now, '%H:%M') == date.format(now_sec, '%H:%M');
		akt_sekunde = now_sec - (diff_minute * 60);
	ELSE;
		akt_sekunde = now_sec;
	END;		

	bis = 60 * zeitrahmen;
	bis_sec = akt_sekunde + (bis * 60);
	bis_minute = bis;
	bis_stunde = date.format(bis_sec, '%H');

	minute = 0;
	z = 0;	
	einheit = ((breite / bis) + 0.5) | format('%i');
-%?>

	<style type="text/css">
		#prgtable { border-left-width:1px; border-left-style:solid; border-bottom-width:1px; border-bottom-style:solid; padding:2px; }
		#timertable { border-left-width:1px; border-left-style:solid; border-bottom-width:1px; border-bottom-style:solid; padding:2px; }

		<?% IF jetzt_stunde >= akt_stunde && jetzt_stunde < akt_stunde + zeitrahmen %?>
		#timeline { position:absolute; filter:Alpha(opacity=50); top:150px; left:<?% left + seite + (einheit * diff_minute) + 30 %?>px; width:1px; height:<?% shows.keys.size * 21 + 2 %?>px; z-index:10; z-index:2; }
		<?% END %?>

		#bigtable { position:absolute; top:100px; left: <?% left %?>px; z-index: 1; }
	</style>

	<script language="JavaScript">
		function Go(x) {
			if(x =="nothing") {
				document.forms[0].reset();
				document.forms[0].elements[0].blur();
				return;
			} else {
				parent.frames[1].location.href = x;
				document.forms[0].elements[0].blur();
			}
		}
	</script>
</head>

<body id="prog_timeline">
	<form action="<?% nowurl %?>" method="get" name="FormName">
		<table width="100%" border="0" cellspacing="0" cellpadding="0" id="heading">
			<tr>
				<td class="col_left"></td>
				<td class="col_title">
					<h1><?% now %?>&nbsp;<%! o'clock !%></h1>
				</td>
				<td class="col_other">
					<%! What's on: !%>&nbsp;
					<select name="Auswahl" class="submit" onChange="Go(this.form.Auswahl.options[this.form.Auswahl.options.selectedIndex].value)" style="width:100px" width="100">
						<option value="<?% nowurl %?>"><%! now !%></option>
<?% FOREACH timer = times %?>
	<?% timer_o_dopp = timer | replace('\:', '') %?>
						<option value="<?% nowurl %?>&time=<?% timer_o_dopp %?>" <?% "selected" IF now == timer %?>><?% timer %?></option>
<?% END %?>
					</select>
					&nbsp;|&nbsp;<%! at: !%>&nbsp;
					<input type="text" name="time" size="5" value="<?% now %?>" />
					&nbsp;<%! o'clock !%>
					<input type="hidden" name="aktion" value="prog_timeline" />
				</td>
				<td class="col_right"></td>
			</tr>
		</table>

		<!-- Vertikal ansicht TOP -->
		<span id="timeline" class="timeline"><img src="bilder/spacer.gif" width="1" height="1" border="0" /></span>

		<div id="content">
			<!-- Zeitleiste -->
			<table width="<?% breite + seite + 60 %?>" border="0" cellspacing="0" cellpadding="0" id="bigtable" class="list">
				<tr class="heading">
					<td class="col_left"></td>
					<td colspan="3" width='<?% breite + seite %?>'><h2><%! Timeline: !%>&nbsp;<?% date.format(akt_sekunde, '%H:%M') %?>&nbsp;<%! o'clock !%>&nbsp;<%! to !%>&nbsp;<?% date.format(bis_sec, '%H:%M') %?>&nbsp;<%! o'clock !%></h2></td>
					<td class="col_navi">
						<?% IF akt_stunde <= jetzt_stunde %?>
							<img src="bilder/pfeile_nachlinks_soft.gif" border="0" width="28" height="17" />
						<?% ELSE %?>
							<a href="<?% nowurl %?>&time=<?% akt_stunde - zeitrahmen | format('%02d') %?><?% akt_minute | format('%02d') %?>">
								<img src="bilder/pfeile_nachlinks.gif" border="0" width="28" height="17" />
							</a>
						<?% END %?>
						<a href="<?% nowurl %?>&time=<?% bis_stunde | format('%02d') %?><?% akt_minute | format('%02d') %?>">
							<img src="bilder/pfeile_nachrechts.gif" border="0" width="29" height="17" />
						</a>
					</td>
					<td class="col_right"></td>
				</tr>
				<tr class="row_spacer">
					<td class="col_left"></td>
					<td colspan="4"></td>
					<td class="col_right"></td>
				</tr>
				<tr class="row_odd">
					<td class="col_left"></td>
					<td colspan="4">
						<table border="0" cellpadding="0" cellspacing="0" width="1">
							<tr>
								<td class="color1"><img src="bilder/spacer.gif" width="<?% seite %?>" height="1" border="0" /><br /></td>
<?% WHILE minute < bis %?>
								<td colspan="6" class='<?% minute % 60 ? "color1" : "color2" %?>'>
									<img src="bilder/spacer.gif" width="<?% einheit * 30 %?>" height="1" border="0" /><br />
	<?% zeit = akt_sekunde + (minute * 60) %?>
									<b><?% date.format(zeit, '%H:%M') %?></b>
								</td>
	<?% minute = minute + 30 %?> 
<?% END %?>
							</tr>
<?% minute = 0 %?>
							<tr>
								<td class="color1"><img src="bilder/spacer.gif" width="<?% seite %?>" height="1" border="0" /><br /></td>
<?% WHILE minute < bis %?>
								<td  width="1%" align="left" valign="bottom" class=<?% minute % 10 ? "color1" : "color2" %?>>
	<?% IF minute % 15 %?>
									<img src="bilder/pixel.gif" width="1" height="5" border="0" />
	<?% ELSE %?>
									<img src="bilder/pixel.gif" width="1" height="10" border="0" />
	<?% END %?>
								</td>
	<?% minute = minute + 5 %?> 
<?% END %?>
							</tr>
						</table>

						<table border="0" cellpadding="0" cellspacing="0" width="1">
<!-- Sendernamen -->
<?% b = 0;
	FOREACH name = shows.keys.nsort; 
		old_stop_minute = -1;
		chars = seite / 10 | format('%i');
		b = b + 1 %?>
							<tr>
								<td valign="top" class=<?% b % 2 ? "color2" : "color1" %?>>
									<img src="bilder/spacer.gif" width="<?% seite %?>" height="1" border="0" /><br />
									<a href="<?% shows.${name}.first.proglink %?>"><b><?% shows.${name}.first.progname | truncate(chars) %?></b></a>
								</td>
								<!-- Programm -->
								<td colspan="<?% (bis / 5) %?>" class=<?% b % 2 ? "color2" : "color1" %?>>
									<nobr>
<?%
		z = 0;
		FOREACH show = shows.${name}; 
			start_stunde = date.format(show.start, '%H') - akt_stunde;
#			start_stunde = (start_stunde < 0 ? 0 : start_stunde);
			start_minute = date.format(show.start, '%M') - akt_minute;
			start_minute = (start_stunde * 60 ) + start_minute;

			show.stop = show.stop - 60;
			stop_stunde = date.format(show.stop, '%H') - akt_stunde;
			stop_stunde = (stop_stunde < 0 ? 0 : stop_stunde);
			stop_minute = date.format(show.stop, '%M') - akt_minute;
			stop_minute = (stop_stunde * 60 )+ stop_minute;

			IF start_minute < akt_minute; start_minute = 0; END;
			IF stop_minute  > bis_minute; stop_minute  = bis_minute; END;

			laenge = stop_minute - start_minute;
			laenge_pix = laenge * einheit;
			laenge_chars = ((laenge_pix / 10) + 0.5) | format('%i');
			NEXT IF start_minute >= bis_minute;
			IF start_minute >= old_stop_minute;
	    start_minute = start_minute + 1 IF start_minute == old_stop_minute;
%?>

		<?% IF start_minute > akt_minute && ! z %?>
			<?% diff = (start_minute - akt_minute) * einheit %?> 
									<table border="0" align="left" cellpadding="0" cellspacing="0">
										<tr>
											<td width="1">
												<img src="bilder/spacer.gif" width="<?% diff %?>" height="8" border="0" align="left" hspace="0" />
											</td>
										</tr>
									</table>
		<?% END %?>

		<?% IF old_stop_minute + 1 < start_minute && z %?>
			<?% diff = (start_minute - old_stop_minute - 1) * einheit %?> 
									<img title="DiffMinute: <?% start_minute - old_stop_minute - 1 %?>" src="bilder/spacer.gif" width="<?% diff %?>" height="8" border="0" align="left" hspace="0" />
		<?% END %?>
		<?% td_class = date.now > show.start && date.now < show.stop ? "color_current" : "color_broadcast";
				td_class = show.timer ? "color_timer" : td_class %?>
									<table border="0" align="left" cellpadding="0" cellspacing="0" id=<?% show.timer ? "timertable" : "prgtable" %?>>
										<tr>
											<td width="1" class="<?% td_class %?>">
												<img src="bilder/spacer.gif" width="<?% laenge_pix %?>" height="1" border="0" hspace="0" /><br />
												<nobr>
													<?% IF show.summary %?><a href="javascript:popup('./vdradmin.pl?aktion=prog_detail&epg_id=<?% show.anchor %?>&vdr_id=<?% show.vdr_id %?>');"><?% END %?>
													<span title="<?% show.title %?> (<?% date.format(show.start, '%H:%M') %?> - <?% date.format(show.stop, '%H:%M') %?>, <?% (show.stop - show.start) / 60 %?><%! min !%>)">
													<?% IF laenge_chars > 2 %?>
														<?% show.title | truncate( laenge_chars ) %?>
													<?% ELSE %?>
														<img src="bilder/spacer.gif" width="<?% laenge_pix %?>" height="8" border="0" hspace="0" />
													<?% END %?>
													</span>
													<?% IF show.summary %?></a><?% END %?>
												</nobr>
											</td>
										</tr>
									</table>
	<?% 
		END;
		z = z + 1; 
		old_start_minute = start_minute;
		old_stop_minute = stop_minute;
		END %?>
									</nobr>
								</td>
							</tr>
<?% END %?>
						</table>
					</td>

<!-- Vertikal ansicht END -->
					<td class="col_right"></td>
				</tr>
				<tr class="footer">
					<td class="col_left"></td>
					<td colspan="4"></td>
					<td class="col_right"></td>
				</tr>
			</table>
		</div>
	</form>
</body>
</html>
