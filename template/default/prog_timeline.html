<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>

<head>
	<meta http-equiv="refresh" content="600; URL=vdradmin.pl?aktion=prog_timeline" />
	<meta http-equiv="content-type" content="text/html;charset=<%! ISO-8859-1 !%>" />
	<title>VDRAdmin-AM - <%! Timeline !%></title>
	<link href="style.css" rel="stylesheet" media="screen" type="text/css" />
	<tmpl_if usercss>
		<link href="user.css" rel="stylesheet" media="screen" type="text/css" />
	</tmpl_if>
	<script type="text/javascript" language="JavaScript1.2" src="library.js"></script>

<?%- 
	breite = 600;
	seite = 100;
	zeitrahmen 	= config.ZEITRAHMEN || 1; # Zeitrahmen der angezeigt werden soll in Stunden
	times 		= config.TIMES.split(',\s*');
	
	USE date;
	jetzt_stunde = date.format(date.now, '%H');
	jetzt_minute = date.format(date.now, '%M');
	akt_stunde = date.format(now_sec, '%H');
	akt_minute = (date.format(now_sec, '%M') < 30 ? '00' : '30');
	diff_minute = jetzt_minute - akt_minute; 

	IF date.format(date.now, '%H:%M') == date.format(now_sec, '%H:%M');
		akt_sekunde = now_sec - (diff_minute * 60);
	ELSE;
		akt_sekunde = now_sec;
	END;		
	akt_sekunde = akt_sekunde - akt_sekunde % 60;

	bis = 60 * zeitrahmen;
	bis_sec = akt_sekunde + (bis * 60);
	bis_minute = bis;
	bis_stunde = date.format(bis_sec, '%H');

	minute = 0;
	z = 0;	
	einheit = ((breite / bis) + 0.5) | format('%i');
	breite = bis * einheit;
-%?>

	<style type="text/css">
		table.prgname {
			border-width:1px;
			border-style:none;
			border-spacing:0px;
			padding:0px;
			margin:0px;
			text-align:left;
			table-layout:fixed;
			overflow:hidden;
		}
		td.prgname {
			margin: 0 2px;
		}

		.prgtable {
			border-left-width:1px;
			border-right-width:1px;
			border-top-width:0px;
			border-bottom-width:1px;
			border-left-style:solid;
			border-right-style:solid;
			border-top-style:none;
			border-bottom-style:solid;
			border-spacing:0px;
			padding:0px;
			margin:0px;
			text-align:left;
			table-layout:fixed;
			overflow:hidden;
		}
		.prgtable span,
		.timertable span {
			padding: 0 2px;
		}

		.timertable {
			border-left-width:1px;
			border-right-width:1px;
			border-top-width:0px;
			border-bottom-width:1px;
			border-left-style:solid;
			border-right-style:solid;
			border-top-style:none;
			border-bottom-style:solid;
			border-spacing:0px;
			padding:0px;
			margin:0px;
			text-align:left;
			table-layout:fixed;
			overflow:hidden;
		}

		.timestables {
			border-left-width:1px;
			border-right-width:1px;
			border-top-width:0px;
			border-bottom-width:1px;
			border-left-style:solid;
			border-right-style:solid;
			border-top-style:none;
			border-bottom-style:solid;
			border-spacing:0px;
			border-color:black;
			padding:0px;
			margin:0px;
			table-layout:fixed;
		}

		<?% IF (date.now >= akt_sekunde) && (date.now - akt_sekunde < bis_sec) %?>
			#timeline { position:absolute; filter:Alpha(opacity=50); top:20px; left:<?% seite + (einheit * diff_minute) + 30 %?>px; width:1px; height:<?% shows.keys.size * 18 + 19 %?>px; z-index:10; z-index:2; }
		<?% END %?>

		#bigtable { position:absolute; top:0; left: 0; z-index: 1; }
	</style>

	<script type="text/javascript" language="JavaScript">
		function Go(x) {
			if(x =="nothing") {
				document.forms[0].reset();
				document.forms[0].elements[0].blur();
				return;
			} else {
				parent.frames[1].location.href = x;
				document.forms[0].elements[0].blur();
			}
		}
	</script>
<?% IF config.TL_TOOLTIP %?>
	<script type="text/javascript" language="JavaScript1.2" src="infobox.js"></script>
<?% END %?>
</head>

<body id="prog_timeline">
<?% IF config.TL_TOOLTIP %?>
	<div id="infodiv" style="position:absolute; visibility:hidden; z-index:20; top:0px; left:0px;"></div>
	<script language="JavaScript" type="text/javascript">
	<?%
		FOREACH name = shows2.keys.nsort;
			counter = 0;
			FOREACH show = shows2.${name};
	%?>
				maketip("VDR-<?% show.vdr_id %?>-<?% counter %?>", "<?% show.title %?>", "<%! Duration: !%> <?% date.format(show.start, '%H:%M') %?> - <?% date.format(show.stop, '%H:%M') %?> (<?% (show.stop - show.start) / 60 %?><%! min !%>)" );
	<?%
				counter = counter + 1;
			END;
		END;
	%?>
	</script>
<?% END %?>

	<form action="<?% nowurl %?>" method="get" name="FormName">
		<table width="100%" border="0" cellspacing="0" cellpadding="0" id="heading">
			<tr>
				<td class="col_left"></td>
				<td class="col_title">
					<h1><?% now %?>&nbsp;<%! o'clock !%></h1>
				</td>
				<td class="col_other">
					<%! What's on: !%>&nbsp;
					<select name="Auswahl" class="submit" onChange="Go(this.form.Auswahl.options[this.form.Auswahl.options.selectedIndex].value)" style="width:100px" width="100">
						<option value="<?% nowurl %?>"><%! now !%></option>
<?% FOREACH timer = times %?>
	<?% timer_o_dopp = timer | replace('\:', '') %?>
						<option value="<?% nowurl %?>&amp;time=<?% timer_o_dopp %?>" <?% "selected" IF now == timer %?>><?% timer %?></option>
<?% END %?>
					</select>
					&nbsp;|&nbsp;<%! at: !%>&nbsp;
					<input type="text" name="time" size="5" value="<?% now %?>" />
					&nbsp;<%! o'clock !%>
					<input type="hidden" name="aktion" value="prog_timeline" />
				</td>
				<td class="col_right"></td>
			</tr>
		</table>


		<div id="content">
			<!-- Vertikal ansicht TOP -->
			<span id="timeline"><img src="bilder/spacer.gif" width="1" height="1" border="0" /></span>

 <!-- Zeitleiste: akt="<?% date.format(akt_sekunde, '%H:%M:%S') %?>" jetzt="<?% date.format(date.now, '%H:%M:%S') %?>" -->
			<table width="<?% breite + seite + 60 %?>" border="0" cellspacing="0" cellpadding="0" class="bigtable list">
				<tr class="heading">
					<td class="col_left"></td>
					<td colspan="3" width='<?% breite + seite %?>'><h2><%! Timeline: !%>&nbsp;<?% date.format(akt_sekunde, '%H:%M') %?>&nbsp;<%! o'clock !%>&nbsp;<%! to !%>&nbsp;<?% date.format(bis_sec, '%H:%M') %?>&nbsp;<%! o'clock !%></h2></td>
					<td class="col_navi"><?% IF akt_sekunde <= date.now %?><img src="bilder/pfeile_nachlinks_soft.png" border="0" /><?% ELSE %?><a href="<?% nowurl %?>&amp;time=<?% akt_stunde - zeitrahmen | format('%02d') %?><?% akt_minute | format('%02d') %?>"><img src="bilder/pfeile_nachlinks.png" border="0" /></a><?% END %?><a href="<?% nowurl %?>&amp;time=<?% bis_stunde | format('%02d') %?><?% akt_minute | format('%02d') %?>"><img src="bilder/pfeile_nachrechts.png" border="0" /></a></td>
					<td class="col_right"></td>
				</tr>
				<tr class="row_spacer">
					<td class="col_left"></td>
					<td colspan="4"></td>
					<td class="col_right"></td>
				</tr>
				<tr class="row_even">
					<td class="col_left"></td>
					<td colspan="4">
						<table border="0" cellpadding="0" cellspacing="0" width="<?% seite + breite %?>" class="timestable">
							<tr>
								<td><img src="bilder/spacer.gif" width="<?% seite %?>" height="1" border="0" /><br /></td>
<?% WHILE minute < bis %?>
								<td colspan="6" class="<?% minute % 60 ? 'color1' : 'color2' %?>">
									<img src="bilder/spacer.gif" width="<?% einheit * 30 %?>" height="1" border="0" /><br />
	<?% zeit = akt_sekunde + (minute * 60) %?>
									<span class="date_time"><?% date.format(zeit, '%H:%M') %?></span>
								</td>
	<?% minute = minute + 30 %?> 
<?% END %?>
							</tr>
<?% minute = 0 %?>
							<tr>
								<td><img src="bilder/spacer.gif" width="<?% seite %?>" height="1" border="0" /><br /></td>
<?% WHILE minute < bis %?>
								<!-- TODO: unit for next "width" and "height"? -->
								<td width="<?% einheit * 5 %?>" height="10" align="left" valign="bottom" class="<?% minute % 10 ? 'color1' : 'color2' %?>">
 									<img src="bilder/spacer.gif" width="<?% einheit * 5 %?>" height="10" border="0" />
								</td>
	<?% minute = minute + 5 %?> 
<?% END %?>
							</tr>
						</table>

						<table border="0" cellpadding="0" cellspacing="0" width="<?% seite + breite %?>" class="prgname">
<?% b = 0;
	FOREACH name = shows.keys.nsort; 
		b = b + 1 %?>
							<tr>
								<!-- Sendername: "<?% shows.${name}.first.progname %?>" -->
								<td width="<?% seite %?>" valign="top" class="prgname <?% b % 2 ? 'color2' : 'color1' %?>">
									<img src="bilder/spacer.gif" width="<?% seite %?>" height="1" border="0" /><br />
									<nobr><a href="<?% shows.${name}.first.proglink %?>" class="channel_name"><?% shows.${name}.first.progname %?></a></nobr>
								</td>
								<!-- Programm -->
								<td colspan="<?% (bis / 5) %?>" class="<?% b % 2 ? 'color2' : 'color1' %?>">
									<nobr>
<?%
		counter = 0;
		old_stop_minute = -1;
		FOREACH show = shows.${name}; 
			start_minute = (show.start - akt_sekunde) / 60 | format('%i');
			stop_minute = (show.stop - akt_sekunde) / 60 | format('%i');

			IF start_minute < akt_minute; start_minute = 0; END;
			IF stop_minute  > bis_minute; stop_minute  = bis_minute; END;

			laenge_pix = (stop_minute - start_minute) * einheit;

			IF show.timer; 
				td_class = "color_timer";
			ELSE;
				td_class = date.now >= show.start && date.now < show.stop ? "color_current" : "color_broadcast";
			END;
%?>
 
<!-- old_stop="<?% old_stop_minute %?>" start="<?% start_minute %?>" stop="<?% stop_minute %?>" bis="<?% bis_minute %?>" -->
<?% IF (start_minute >= old_stop_minute) && (start_minute < bis_minute) %?>
<?% IF old_stop_minute + 1 < start_minute %?>
<?% diff = (start_minute - old_stop_minute - 1) * einheit %?> 
<!-- Spacer -->
									<table border="0" align="left" cellpadding="0" cellspacing="0" width="<?% diff %?>" class="prgtable">
										<tr>
											<td width="1">
												<img src="bilder/spacer.gif" width="1" height="1" border="0" hspace="0" /><br/>
												<nobr>
													<img src="bilder/spacer.gif" width="1" height="8" border="0" hspace="0" />
												</nobr>
											</td>
										</tr>
									</table>
		<?% END %?>
									<!-- <?% show.vdr_id %?>-<?% counter %?>: "<?% show.title %?>" -->
									<table border="0" align="left" cellpadding="0" cellspacing="0" width="<?% laenge_pix %?>" class=<?% show.timer ? "timertable" : "prgtable" %?>>
										<tr>
											<td width="1" class="<?% td_class %?>" <?% IF config.TL_TOOLTIP %?>onMouseOver="tip('VDR-<?% show.vdr_id %?>-<?% counter %?>'); return true;" onMouseOut="untip(); return true;"<?% END %?>>
												<img src="bilder/spacer.gif" width="1" height="1" border="0" hspace="0" /><br />
												<span class="event">
													<?% IF show.summary %?>
														<a href="javascript:popup('./vdradmin.pl?aktion=prog_detail&amp;epg_id=<?% show.anchor %?>&amp;vdr_id=<?% show.vdr_id %?>');">
															<?% show.title %?>
														</a>
													<?% ELSE %?>
														<?% show.title %?>
													<?% END %?>
												</span>
											</td>
										</tr>
									</table>
	<?% 
		old_stop_minute = stop_minute;
		END;
 		counter = counter + 1;
		END %?>
									</nobr>
								</td>
							</tr>
<?% END %?>
						</table>
					</td>

<!-- Vertikal ansicht END -->
					<td class="col_right"></td>
				</tr>
				<tr class="footer">
					<td class="col_left"></td>
					<td colspan="4"></td>
					<td class="col_right"></td>
				</tr>
			</table>
		</div>
	</form>
</body>
</html>
